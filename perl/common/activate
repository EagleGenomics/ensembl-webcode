#!/usr/local/bin/perl

package activate;

use CGI;

my $cgi = new CGI;
use EnsEMBL::Web::Document::DataView;
use EnsEMBL::Web::Interface::PageDefinition;
use EnsEMBL::Web::Interface::FormDefinition;
use EnsEMBL::Web::DBSQL::DataDefinition;
use EnsEMBL::Web::DBSQL::ViewAdaptor;
use EnsEMBL::Web::SpeciesDefs;

my $page = EnsEMBL::Web::Interface::PageDefinition->new();
my $data = EnsEMBL::Web::DBSQL::DataDefinition->new();
my $db = $EnsEMBL::Web::Apache::Handlers::ENSEMBL_USER_DB_HANDLE;
$data->adaptor(EnsEMBL::Web::DBSQL::ViewAdaptor->new((
                                                       handle => $db,
                                                       table  => 'user'
                                                    )) );

my $sd = EnsEMBL::Web::SpeciesDefs->new();
my $site_info = {};
my $sitetype = $sd->ENSEMBL_SITETYPE;
my $sitename = $sitetype eq 'EnsEMBL' ? 'Ensembl' : $sitetype;
$site_info->{'name'} = $sitename;
$site_info->{'base_url'}    = $sd->ENSEMBL_BASE_URL;
$site_info->{'mail_server'} = $sd->ENSEMBL_MAIL_SERVER;
$site_info->{'help_email'}  = $sd->ENSEMBL_HELPDESK_EMAIL;

if (!$cgi->param('welcome_email')) {
  my $user = EnsEMBL::Web::Object::User->new({ id => $cgi->param('id') });
  send_activation_email($user, $site_info);
} elsif ($cgi->param('welcome_email') eq 'yes') {
  my $user = EnsEMBL::Web::Object::User->new({ id => $cgi->param('id') });
  send_welcome_email($user, $site_info);
}

$data->discover;
$data->populate($cgi->param('id'));
$page->data_definition($data);
$page->title("Activate your $sitename account");
$page->action('edit');
$page->send_params({ id => 'yes', salt => 'yes', password => 'yes' });
$page->on_complete('/common/set_cookie');
$page->on_error('/error/activate.html');

$page->add_configuration_element('conditional', 'salt');
$page->add_configuration_element('welcome_email', 'yes');

$page->add_display_element('name', "User name");
$page->add_display_element('organisation', "Organisation");

$conditional = EnsEMBL::Web::Interface::FormDefinition->new();
$conditional->add_option({ 'conditional' => 1 });

$page->add_form_element('salt', "Your activation code", $conditional);
$page->add_form_element('password', "Your password");

EnsEMBL::Web::Document::DataView::simple('User', $page);

sub send_activation_email {
  my ($user, $site_info) = @_;
  my $sitename = $site_info->{'name'};
  my $message = qq(
  Welcome to $sitename,

  Thanks for registering with $sitename.
  
  You just need to activate your account, using the activation code below:
  
  Activation code: ) . $user->salt . qq(
 
  Or by clicking on this link:
  ) . $site_info->{'base_url'} . qq(/common/activate?id=) . $user->id . qq(  


  Many thanks,

  The $sitename web team



  $sitename Privacy Statement: ) . $site_info->{'base_url'} . qq(/info/about/privacy.html
  );
  send_email($site_info, $user, "Your new $sitename account", $message);
}

sub send_welcome_email {
  my ($user, $site_info) = @_;
  my $sitename = $site_info->{'name'};
  my $message = qq(Welcome to $sitename.
  Your account is now activated. More information on how to make the most of 
  your account can be found at:

  ) . $site_info->{'base_url'} . qq(/info/about/accounts.html


  Many thanks,

  The $sitename web team



  $sitename Privacy Statement: ) . $site_info->{'base_url'} . qq(/info/about/privacy.html
  );
  send_email($site_info, $user, "Welcome to $sitename", $message);
}

sub send_email {
  my ($site_info, $user, $subject, $message) = @_;
  warn "Sending email to: " . $user->email . " on " . $site_info->{'mail_server'};
  my $mailer = new Mail::Mailer 'smtp', Server => $site_info->{'mail_server'};
  $mailer->open({
                'To'      => $user->email,
                'From'    => $site_info->{'name'},
                'Reply-To'=> $site_info->{'help_email'},
                'Subject' => $subject
                });
  print $mailer $message;
  $mailer->close();

}

1;
