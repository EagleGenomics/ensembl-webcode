Raphael.fn.g.piechart=function(s,t,m,b,f){f=f||{};var u=this,z=[],r=this.set(),h=this.set(),o=this.set(),p=b.length,w=0,n=0,y=0,q=9,l=true;h.covers=r;if(p==1){o.push(this.circle(s,t,m).attr({fill:f.colors&&f.colors[0]||this.g.colors[0]||"#666",stroke:f.stroke||"#fff","stroke-width":f.strokewidth==null?1:f.strokewidth}));r.push(this.circle(s,t,m).attr(this.g.shim));n=b[0];b[0]={value:b[0],order:0,valueOf:function(){return this.value}};o[0].middle={x:s,y:t};o[0].mangle=180}else{for(var A=function(c,
k,e,d,i){var g=Math.PI/180,j=c+e*Math.cos(-d*g),v=c+e*Math.cos(-i*g),x=c+e/2*Math.cos(-(d+(i-d)/2)*g),B=k+e*Math.sin(-d*g),C=k+e*Math.sin(-i*g);g=k+e/2*Math.sin(-(d+(i-d)/2)*g);c=["M",c,k,"L",j,B,"A",e,e,0,+(Math.abs(i-d)>180),1,v,C,"z"];c.middle={x:x,y:g};return c},a=0;a<p;a++){n+=b[a];b[a]={value:b[a],order:a,valueOf:function(){return this.value}}}for(a=0;a<p;a++){if(l&&b[a]*360/n<=1.5){q=a;l=false}if(a>q){l=false;b[q].value+=b[a];b[q].others=true;y=b[q].value}}p=Math.min(q+1,b.length);y&&b.splice(p)&&
(b[q].others=true);for(a=0;a<p;a++){y=w-360*b[a]/n/2;if(!a){w=360*b[a]/n/2+(360*b[a]/n/2-270);y=w-360*b[a]/n/2}if(f.init)var D=A(s,t,1,w,w-360*b[a]/n).join(",");q=A(s,t,m,w,w-=360*b[a]/n);l=this.path(f.init?D:q).attr({fill:f.colors&&f.colors[a]||this.g.colors[a]||"#666",stroke:f.stroke||"#fff","stroke-width":f.strokewidth==null?1:f.strokewidth,"stroke-linejoin":"round"});l.value=b[a];l.middle=q.middle;l.mangle=y;z.push(l);o.push(l);f.init&&l.animate({path:q.join(",")},+f.init-1||1E3,">")}for(a=0;a<
p;a++){l=u.path(z[a].attr("path")).attr(this.g.shim);f.href&&f.href[a]&&l.attr({href:f.href[a]});l.attr=function(){};r.push(l);o.push(l)}}h.hover=function(c,k){k=k||function(){};for(var e=this,d=0;d<p;d++)(function(i,g,j){var v={sector:i,cover:g,cx:s,cy:t,mx:i.middle.x,my:i.middle.y,mangle:i.mangle,r:m,value:b[j],total:n,label:e.labels&&e.labels[j]};g.mouseover(function(){c.call(v)}).mouseout(function(){k.call(v)})})(o[d],r[d],d);return this};h.each=function(c){for(var k=this,e=0;e<p;e++)(function(d,
i,g){c.call({sector:d,cover:i,cx:s,cy:t,x:d.middle.x,y:d.middle.y,mangle:d.mangle,r:m,value:b[g],total:n,label:k.labels&&k.labels[g]})})(o[e],r[e],e);return this};h.click=function(c){for(var k=this,e=0;e<p;e++)(function(d,i,g){var j={sector:d,cover:i,cx:s,cy:t,mx:d.middle.x,my:d.middle.y,mangle:d.mangle,r:m,value:b[g],total:n,label:k.labels&&k.labels[g]};i.click(function(){c.call(j)})})(o[e],r[e],e);return this};h.inject=function(c){c.insertBefore(r[0])};z=function(c,k,e,d){var i=s+m+m/5,g=t+10;c=
c||[];d=d&&d.toLowerCase&&d.toLowerCase()||"east";e=u.g.markers[e&&e.toLowerCase()]||"disc";h.labels=u.set();for(var j=0;j<p;j++){var v=o[j].attr("fill"),x=b[j].order;b[j].others&&(c[x]=k||"Others");c[x]=u.g.labelise(c[x],b[j],n);h.labels.push(u.set());h.labels[j].push(u.g[e](i+5,g,5).attr({fill:v,stroke:"none"}));h.labels[j].push(v=u.text(i+20,g,c[x]||b[x]).attr(u.g.txtattr).attr({fill:f.legendcolor||"#000","text-anchor":"start"}));r[j].label=h.labels[j];g+=v.getBBox().height*1.2}c=h.labels.getBBox();
h.labels.translate.apply(h.labels,{east:[0,-c.height/2],west:[-c.width-2*m-20,-c.height/2],north:[-m-c.width/2,-m-c.height-10],south:[-m-c.width/2,m+10]}[d]);h.push(h.labels)};f.legend&&z(f.legend,f.legendothers,f.legendmark,f.legendpos);h.push(o,r);h.series=o;h.covers=r;return h};
