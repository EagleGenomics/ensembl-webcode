<html>
  <head>
    <meta name="navigation" content="Configuration" />
    <title>Configuring an Ensembl Website</title>
  </head>
<body>
  <h2>Configuring an Ensembl Website</h2>

<p>
  This section explains the configuration changes you have to
  make so that Ensembl will run on your local set-up.
</p>

<h3 class="boxed">File Configuration</h3>

<p>
  The configuration for the website is split up into site-wide
  configuration (Apache config, global settings) and species-specific
  configuration (database names, and so on). Site-wide configuration
  is stored inSiteDefs.pm, while the species-specific config is kept
  in species_name.ini files (e.g. Homo_sapiens.ini).
  There needs to be a species-specific .ini file for each species
  you want to display on your Ensembl website.
</p>

<p>
  In addition to these configuration files, there is a DEFAULTS.ini
 file and a MULTI.ini file. DEFAULTS.ini holds default values for
  the species-specific .ini files; i.e. unless you override these
  settings in a particular species ini file, they will apply to all
  species. This is simply to save having to make the same
  setting in multiple species ini files.
</p>

<p>
  MULTI.ini contains multi-species settings. This currently contains
  database connection information for the Compara and
  Mart databases.
</p>


<p>
  The default configuration files can all be found in the "conf"
  subdirectory of your server-root.
</p>

<p>
  <strong>If you have installed
  Ensembl prior to release 31 you will have editted these files
  in the conf directory. As from version 32 there is a new
  approach to the configuration of the site.</strong>
</p>

<h3 class="boxed">PLUGINS</h3>

<p>
  Elsewhere in the documentation you will read about how to extend
  Ensembl by writing your own <strong>plugins</strong>. A by product
  of this extensibility is that you can also use plugins to simply
  configure your server.
</p>

<p>
  When you checked out your copy of Ensembl you will find that you
  created a directory called <strong>public-plugins</strong> inside
  this is a folder called mirror which contains a <strong>conf</strong>
  directory. This contains DEFAULTS.ini and SiteDefs.pm files which
  can be used to configure your copy of Ensembl.
</p>
<h4>Setting up the "Mirror Plugin"</h4>
<p>
  In the main conf directory you will find a file called <strong>Plugins.pm-dist</strong>
  The first thing to do is to make a copy of this without the -dist extension.
  This sets up the mirror plugin mentioned above.
</p>
<p>
  Now go into the <strong>public-plugins/mirror/conf</strong> directory and
  make changes to the SiteDefs.pm and DEFAULTS.ini listed below:
</p>
<h3 class="boxed">public-plugins/mirror/conf/SiteDefs.pm</h3>

<p>
  First copy SiteDefs.pm-dist to SiteDefs.pm in this directory.
  If you open this file in a text editor, such as vi, you will see it is
  actually a Perl module, containing a single method "update_conf" which 
  contains, changes you need to make to configure your copy of the website.
</p>

<p>
  This methods consists of a list of variables (of the form $SiteDefs::ENSEMBL_whatever),
  and a value for the variable, and a comment (after a # symbol) about the variable.
</p>
<p>
  These are the variables you will need to change to match your installation. There
  are other variables that you can change (you can change any variables that are
  defined in the main SiteDefs.pm file.
</p>

<h4>General configuration</h4>

<p>$SiteDefs::ENSEMBL_SERVERROOT sets the filesystem location of the web server root directory. By default, this is
determined dynamically based on the location of the SiteDefs.pm file. You can, however, hard-code this
value if you wish. For example, if you installed the Ensembl site in /usr/local/ensembl, then you could
change this line of SiteDefs to read:</p>
<pre>
  $SiteDefs::ENSEMBL_SERVERROOT = '/usr/local/ensembl';
</pre>
<p>You should only change the values, that is the parts between single quotes.</p>

<h4>Configuration of the Apache web server</h4>
<p>Change $SiteDefs::ENSEMBL_SERVERNAME to the web name of the server - e.g. "www.yoursite.org". This value is
dynamically set to the server hostname by default.</p>
<p>Change $SiteDefs::ENSEMBL_USER and $SiteDefs::ENSEMBL_GROUP to the system user and group you want the Apache
web server to run as. Usually, for security, this is a special user (such as "nobody") who has very few
permissions.</p>

<h4>Mail configuration - error messages</h4>
<p>If you want errors to be automatically emailed to you, change $SiteDefs::ENSEMBL_MAIL_ERRORS to the value 1,
and change $SiteDefs::ENSEMBL_ERRORS_TO to your email address. If you don't want errors mailed, set
$SiteDefs::ENSEMBL_MAIL_ERRORS to 0.</p>

<h4>User database - Database and cookie configuration</h4>
<p>Change the values of $SiteDefs::ENSEMBL_USERDB_NAME, $SiteDefs::ENSEMBL_USERDB_HOST,
$SiteDefs::ENSEMBL_USERDB_USER, $SiteDefs::ENSEMBL_USERDB_PASS, to the details for your web_user database,
remembering that this database needs a user with update/insert/delete privileges. Additionally you will
may wish to change the encryption keys used to "protect" the cookies - $SiteDefs::ENSEMBL_ENCRYPT_0 should
be a six digit hex-number, $SiteDefs::ENSEMBL_ENCRYPT_1, _2 and _3 should each contain two alphanumeric
characters. Unless you are particularly concerned about people changing cookies, the default values
will probably do.</p>

<h4>Enabling Species [*** UPDATE ***]</h4>
<p>$SiteDefs::ENSEMBL_SPECIES_ALIASES contains a hash of species aliases against species names. This is
created by populating %__species_aliases</p>
<pre>
  %__species_aliases = (
  'Bos_taurus'        => [qw(bt cow)],
  'Canis_familiaries' => [qw(cf dog)],

  );
</pre>

<p>In this distribution all species are enabled, to disable a species in your SiteDefs.pm "update_conf" method
you need to manipulate this hash:
</p>
<ol>
  <li>To delete a species:<br />
  <tt>&nbsp; &nbsp; delete( $SiteDefs::__species_aliases{'Bos_taurus'} );</tt>
  </li>
  <li>To add a new species:<br />
  <tt>&nbsp; &nbsp; $SiteDefs::__species_aliases{'New_species'} = [qw(ns new)];</tt>
  </li>
  <li>To add an additional alias to a species:<br />
  <tt>&nbsp; &nbsp; push @{$SiteDefs::__species_aliases{'Pan_troglodytes'}}, qw(chimpanzee);</tt>
  </li>
</ol>
<p>The keys of the hash (the species names on the left hand side) defines the list of valid species for
this website. The values of the hash (the aliases on the left) can be used in URLs instead of the longer
species names. i.e.</p>
<kbd><a href="/mouse/contigview?l=1:4m-4.1m">http://my.ensembl.site/mouse/contigview</a></kbd>
<p>is identical to</p>
<kbd><a href="/Mus_musculus/contigview?l=1:4m-4.1m">http://my.ensembl.site/Mus_musculus/contigview</a></kbd>

<p>To configure a species it has to be present as a value in the $SiteDefs::ENSEMBL_SPECIES_ALIASES hash, and
it has to have an appropriately-named .ini file in the conf/ini_files directory.</p>

<p>You might also want to change $SiteDefs::ENSEMBL_PERL_SPECIES - this is a special alias for URLs of the form
http://my.ensembl.site/perl/contigview, for purely historical reasons. It will probably be used in the future
to set the default species for multi-species pages/functions.</p>

<h4>Temporary Files</h4>

<p>There are three temporary file locations that can be configured:</p>
<pre>
  $SiteDefs::ENSEMBL_TMP_DIR       General storage for temporary files
  $SiteDefs::ENSEMBL_TMP_DIR_IMG   Storage for image files
  $SiteDefs::ENSEMBL_TMP_DIR_BLAST Storage for blast files
</pre>
<p>The values for these should be set to an appropriate filesystem path.</p>

<p>Some temporary files need to be referenced by URL from web pages. The first two tmp directories
above therefore have URL aliases, also configured within SiteDefs.pm. You should not need to edit
these.</p>
<pre>
  $SiteDefs::ENSEMBL_TMP_URL       URL alias for $ENSEMBL_TMP_DIR
  $SiteDefs::ENSEMBL_TMP_URL_IMG   URL alias for $ENSEMBL_TMP_DIR_IMG
</pre>
<p>There are two further temporary file configuration options available:</p>
<ul>
<li>$SiteDefs::ENSEMBL_TMP_CREATE If set, then at apache startup the server will attempt to create
any temporary directories that have been configured, but
which don't already exist. It also changes their ownership to
$SiteDefs::ENSEMBL_USER.$SiteDefs::ENSEMBL_GROUP</li>
<li>$SiteDefs::ENSEMBL_TMP_DELETE If set, then at apache startup the server will attempt to delete
the contents of $ENSEMBL_TMP_DIR and
$SiteDefs::ENSEMBL_TMP_DIR_IMG.</li>
</ul>
<h3 class="boxed">public-plugins/mirror/conf/ini-files/DEFAULTS.ini and public-plugins/mirror/conf/ini-files/[Species_name].ini</h3>
<p>
Again the first thing to do is make a copy of the DEFAULTS.ini-dist file as DEFAULTS.ini,
then you will need to go in and edit the appropriate lines of the DEFAULTS.ini.
</p>
<p>
<strong>
  From version 33 onwards you should be able to re-use the same Plugins.pm, SiteDefs.pm and
  DEFAULTS.ini file to configure your new Ensembl.
</strong></p>

<p>The format of the species-specific .ini files are similar to a standard windows ini file, i.e. split into
sections identified by a header in square brackets, which contain key = value entries. When the Apache
server is started, these files are parsed and stored in a file called config.packed in the conf directory.
This config.packed file is regenerated whenever the server is restarted.</p>

<h4>Database configuration</h4>
<p>In the [general] section, change the values of ENSEMBL_DBUSER and ENSEMBL_DBPASS to the
username and password you want MySQL to be accessed by. Set ENSEMBL_HOST and
ENSEMBL_HOST_PORT to be the database server and port that MySQL is running on.</p>

<p>These are default settings - you can override them by adding a section for a particular database. For
example, adding a section like the following into the mirror plugin would override the defaults in public-plugin for the Help database:</p>
<pre>
[ENSEMBL_HELP]
USER=mysqluser2
PASS=helppass
HOST=mysqlserver2
PORT=4444
</pre>
<h4>Names of databases</h4>
<p>In the [databases] section, change the values of ENSEMBL_DB, ENSEMBL_EST, etc. to match the
names of the core, EST, etc. databases you created.</p>

<h4>DAS Proxy</h4>
<p>If you wish to display external DAS sources on your ensembl installation, and are behind a firewall, then
you will need to set a value for ENSEMBL_DAS_PROXY. This should probably be set in DEFAULTS.ini,
as the proxy is likely to be the same for all species. The value should be your usual web proxy setting,
e.g.</p>
<pre>
ENSEMBL_DAS_PROXY = http://webproxy.mycompany.com:80
</pre>

<h3 class="boxed">MULTI.ini</h3>
<p>Configure the [general] section for connection to the MySQL server, as for the species-specific ini files.
In the [databases] section, change the values of ENSEMBL_COMPARA and the various _MART entries
to match the name of the ensembl_compara and ensembl_mart databases that you created.</p>

<p>In addition, if you chose to install a local GO database you can configure it here by adding an entry:
ENSEMBL_GO = your_go_database_name
to the [databases] section along with ENSEMBL_COMPARA and the BioMart datbases.</p>

<p>As in the other species.ini files, you can override the database connection settings for a particular
database by adding a section similar to the following:</p>
<pre>
[ENSEMBL_MART_ENSEMBL]
USER=mysqluser2
PASS=dbpass
HOST=mysqlserver2
PORT=4444
</pre>
<p>The Mart configuration creates a simplified BioMart configuration file martRegistry.xml in the conf
directory. Read the BioMart install document how to edit this to create a more functional BioMart registry
which leverages BioMart's advanced features such as federated searches.</p>
<h4>BLAST</h4>
<p>It is possible to configure blast for a local installation. See documentation describing how to <a href="blast.html">configure BLAST</a>.

<h3 class="boxed">Note on Ensembl Web Site Search</h3>

<p>The Ensembl web site uses the AltaVista search engine (<a href="http://www.altavista.com/">http://www.altavista.com/</a>). This software
requires a user license and cannot be distributed as part of the Ensembl web code.</p>

<!--DOES NOT WORK WITH NEW SITE<p>As an alternative to using AltaVista, two external contributors, Chen Peng and Dyfed Lloyd-Evans, have
built a system using the new full-text indexing capabilities of MySQL4. You can find the code and
instruction for use in the contrib/mysql_indexer directory, public-web folder.</p>-->

<p>By default, local installations of Ensembl use a simple search page called Unisearch that just does SQL
searches against the database. This method is rather slow and crude, however.</p>

<h3 class="boxed">Site Preparation</h3>
<p>cd into your server root and run the following commands:</p>
<pre>
  mkdir logs
  chown -R $ENSEMBL_USER:$ENSEMBL_GROUP .
</pre>
<p>where $ENSEMBL_USER and $ENSEMBL_GROUP are the web server user &amp; group you configured in
SiteDefs.</p>

<p>Your Ensembl site should now be ready to start up.</p>

<h3 class="boxed">DISCLAIMER</h3>

<p>Please note that the suggested set-up for Apache, mod_perl, MySQL and all Ensembl modules is not
intended to provide high-level security. We strongly recommend that you get your systems administrator
to audit any system that you provide to others. In particular, note that the perl.startup file in the conf
directory may be run as root, so be careful about permissions on this file.</p>

<p>We are not responsible for any damage or loss of data resulting or arising from running the Ensembl
website on your own machines.</p>
</body>
</html>
