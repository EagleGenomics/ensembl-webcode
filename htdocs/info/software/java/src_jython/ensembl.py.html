<pre><font face="Lucida,Courier New"><font color="#008000">#!/usr/bin/env jython
</font><font color="#C00000">from</font> <font color="#000000">__future__</font> <font color="#C00000">import</font> <font color="#000000">nested_scopes</font> <font color="#008000"># compatibility with later versions of Python</font>

<font color="#004080">"""
==========================================
 Ensembl/Jython: Jython interface to Ensj
==========================================
:Authors: - Michael Hoffman &lt;hoffman@ebi.ac.uk&gt;
          - Craig Melsopp &lt;craig@ebi.ac.uk&gt;
:Organization: EMBL-European Bioinformatics Institute
:Contact: helpdesk@ensembl.org
:Address: Wellcome Trust Genome Campus
          Cambridge
          CB10 1SD
          England
:Date: $Date$
:Revision: $Revision$
:Copyright: 2003-2004 EMBL-European Bioinformatics Institute

Usage
=====
&gt;&gt;&gt; import ensembl
&gt;&gt;&gt; ensembl.fetch("ENSRNOG00000007395").description
'BILE ACID-COENZYME A: AMINO ACID N-ACYLTRANSFERASE; BILE ACID-COENZYME A DEHYDROGENASE: AMINO ACID N-ACYLTRANSFERASE. [Source:RefSeq;Acc:NM_017300]'
&gt;&gt;&gt; ensembl.fetch("ENSMUSG00000029992").displayName
'Gfpt1'
&gt;&gt;&gt; exons = ensembl.fetch("ENSG00000139618").transcripts[0].exons # first transcript
&gt;&gt;&gt; first_five_exons = list(exons)[:5]
&gt;&gt;&gt; [exon.accessionID for exon in first_five_exons]
['ENSE00001184784', 'ENSE00000939159', 'ENSE00000939160', 'ENSE00000939161', 'ENSE00000939162']
&gt;&gt;&gt; print "\n".join([str(exon.location) for exon in first_five_exons])
chromosome_NCBI35:13:31787617-31787804:1
chromosome_NCBI35:13:31788559-31788664:1
chromosome_NCBI35:13:31791214-31791462:1
chromosome_NCBI35:13:31797213-31797321:1
chromosome_NCBI35:13:31798238-31798287:1
&gt;&gt;&gt; print exons[0].sequence.string[:50]
GTGGCGCGAGCTTCTGAAACTAGGCGGCAGAGGCGGAGCCGCTGTGGCAC

Description
===========
Most functionality is provided by Ensj_, so consult the `Ensj
documentation`_ for more information on how to use it. Ensembl/Jython
easy access to Ensj databases and objects through its configuration_
system.

.. _Ensj: http://www.ensembl.org/java/
.. _`Ensj documentation`: http://www.ensembl.org/java/documentation.html
.. _configuration:

Configuration
=============

Zero configuration. Ensembl databases on ensembldb.ensembl.org are
automatically made available via DriverGroupFacades loaded into the
ensembl namespace. For example "ensembl.human" provides access to the
latest human database on the server.

DriverGroups specified in the (optional) user registry file are also
loaded into the ensembl namespace when this module is loaded. See the
org.ensembl.registry.Registry javadocs for more information on adding
databases to this file.

Another way of accessiong an ensembl database is via an explicitly created
driver. For example:
&gt;&gt;&gt; d = CoreDriverFacade({host="SOME_HOST", user="SOME_HOST", database="OLD_HUMAN_DATABSE"})
&gt;&gt;&gt; genes = d.geneAdataptor.fetchIterator(Location("chromosome:22"))

The ensembl.fetch(Ensembl_accession_ID) function uses the
ensembl_prefix associated with each DriverGroup to determine which one
to retrieve genes, exons, transcripts and translations from. By
default if you call ensembl.fetch() with an ID beginning with ENSG,
ENST, ENSP, or ENSE the respective feature is retrieved from the
latest human database on ensembldb.ensembl.org. If you want them to be
retrieved from another database then you need to add another
DriverGroup to your user registry file with ensembl_prefix=ENS.


If you have a problem
=====================

1. Get the newest Ensj snapshot and ensembl.py

2. Complain to helpdesk@ensembl.org if it still doesn't work
   automatically.

"""</font>

<font color="#000000">__version__</font> <font color="#0000C0">=</font> <font color="#004080">"$Revision$"</font>

<font color="#C00000">from</font> <font color="#000000">glob</font> <font color="#C00000">import</font> <font color="#000000">glob</font>
<font color="#C00000">import</font> <font color="#000000">os</font>
<font color="#C00000">import</font> <font color="#000000">re</font>
<font color="#C00000">import</font> <font color="#000000">sys</font>
<font color="#C00000">import</font> <font color="#000000">string</font>

<font color="#C00000">import</font> <font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">lang</font>
<font color="#C00000">import</font> <font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">util</font>

<font color="#C00000">from</font> <font color="#000000">org</font><font color="#0000C0">.</font><font color="#000000">ensembl</font> <font color="#C00000">import</font> <font color="#000000">datamodel</font><font color="#0000C0">,</font> <font color="#000000">driver</font><font color="#0000C0">,</font> <font color="#000000">util</font><font color="#0000C0">,</font> <font color="#000000">registry</font>
<font color="#C00000">from</font> <font color="#000000">org</font><font color="#0000C0">.</font><font color="#000000">ensembl</font><font color="#0000C0">.</font><font color="#000000">driver</font><font color="#0000C0">.</font><font color="#000000">impl</font> <font color="#C00000">import</font> <font color="#000000">CoreDriverImpl</font>
<font color="#C00000">from</font> <font color="#000000">org</font><font color="#0000C0">.</font><font color="#000000">ensembl</font><font color="#0000C0">.</font><font color="#000000">variation</font><font color="#0000C0">.</font><font color="#000000">driver</font><font color="#0000C0">.</font><font color="#000000">impl</font> <font color="#C00000">import</font> <font color="#000000">VariationDriverImpl</font>
<font color="#C00000">from</font> <font color="#000000">org</font><font color="#0000C0">.</font><font color="#000000">ensembl</font><font color="#0000C0">.</font><font color="#000000">compara</font><font color="#0000C0">.</font><font color="#000000">driver</font><font color="#0000C0">.</font><font color="#000000">impl</font> <font color="#C00000">import</font> <font color="#000000">ComparaDriverImpl</font>

<font color="#008000"># "from ensembl import *" imports only these module attributes:
</font><font color="#000000">__all__</font> <font color="#0000C0">=</font> <font color="#0000C0">[</font><font color="#004080">"CS_CHROMOSOME"</font><font color="#0000C0">,</font> <font color="#004080">"CS_CONTIG"</font><font color="#0000C0">,</font>
           <font color="#004080">"Location"</font><font color="#0000C0">,</font> <font color="#004080">"CoordinateSystem"</font><font color="#0000C0">,</font>
           <font color="#004080">"AssemblyLocation"</font><font color="#0000C0">,</font> <font color="#004080">"CloneFragmentLocation"</font><font color="#0000C0">,</font>
           <font color="#004080">"DriverFacade"</font><font color="#0000C0">,</font>
           <font color="#004080">"CoreDriver"</font><font color="#0000C0">,</font>
           <font color="#004080">"VariationDriver"</font><font color="#0000C0">,</font>
           <font color="#004080">"ComparaDriver"</font><font color="#0000C0">,</font>
           <font color="#004080">"ensrepr"</font><font color="#0000C0">,</font> <font color="#004080">"ensstr"</font><font color="#0000C0">,</font> <font color="#004080">"fetch"</font><font color="#0000C0">,</font> <font color="#004080">"datamodel"</font><font color="#0000C0">,</font> <font color="#004080">"driver"</font><font color="#0000C0">,</font> <font color="#004080">"util"</font><font color="#0000C0">,</font>
           <font color="#004080">"print_drivers"</font><font color="#0000C0">]</font>


<font color="#008000">#### Globals
</font>
<font color="#000000">_prefix_2_driver_group_facade</font> <font color="#0000C0">=</font> <font color="#0000C0">{</font><font color="#0000C0">}</font>
<font color="#000000">_prefix_2_adaptors</font> <font color="#0000C0">=</font> <font color="#0000C0">{</font><font color="#0000C0">}</font>
<font color="#000000">drivers</font> <font color="#0000C0">=</font> <font color="#0000C0">{</font><font color="#0000C0">}</font>

<font color="#008000">#### constant helper functions
</font>
<font color="#C00000">def</font> <font color="#000000">mkdict</font><font color="#0000C0">(</font><font color="#0000C0">**</font><font color="#000000">keywds</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    mkdict(**keywds) -&gt; new dictionary initialized with the name=value pairs
    in the keyword argument list. For example: mkdict(one=1, two=2)

    Identical to the Python 2.3 idiom dict(one=1, two=2)
    """</font>
    <font color="#C00000">return</font> <font color="#000000">keywds</font>

<font color="#C00000">def</font> <font color="#000000">_within_user_home</font><font color="#0000C0">(</font><font color="#000000">pathname</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    more portable than using os.environ["HOME"]
    or os.path.expanduser("~/.ensembl")
    """</font>
    <font color="#C00000">return</font> <font color="#000000">os</font><font color="#0000C0">.</font><font color="#000000">path</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">lang</font><font color="#0000C0">.</font><font color="#000000">System</font><font color="#0000C0">.</font><font color="#000000">getProperty</font><font color="#0000C0">(</font><font color="#004080">"user.home"</font><font color="#0000C0">)</font><font color="#0000C0">,</font> <font color="#000000">pathname</font><font color="#0000C0">)</font>


<font color="#008000">#### constants
</font>
<font color="#000000">CONF_SPEC</font> <font color="#0000C0">=</font> <font color="#004080">"*.conf"</font>
<font color="#000000">STRAND_SYMBOLS</font> <font color="#0000C0">=</font> <font color="#0000C0">{</font><font color="#0000C0">-</font><font color="#0080C0">1</font><font color="#0000C0">:</font> <font color="#004080">"&lt;-"</font><font color="#0000C0">,</font> <font color="#0080C0">0</font><font color="#0000C0">:</font> <font color="#004080">"-?-"</font><font color="#0000C0">,</font> <font color="#0080C0">1</font><font color="#0000C0">:</font> <font color="#004080">"-&gt;"</font><font color="#0000C0">}</font>
<font color="#000000">ENSID_INFIXES</font> <font color="#0000C0">=</font> <font color="#000000">mkdict</font><font color="#0000C0">(</font><font color="#000000">G</font><font color="#0000C0">=</font><font color="#004080">"ga"</font><font color="#0000C0">,</font> <font color="#008000"># use abbreviations for _AdaptorFacades, not raw adaptors</font>
                       <font color="#000000">T</font><font color="#0000C0">=</font><font color="#004080">"tta"</font><font color="#0000C0">,</font>
                       <font color="#000000">P</font><font color="#0000C0">=</font><font color="#004080">"tna"</font><font color="#0000C0">,</font>
                       <font color="#000000">E</font><font color="#0000C0">=</font><font color="#004080">"ea"</font><font color="#0000C0">)</font>

<font color="#000000">ADAPTOR_ABBREVIATIONS</font> <font color="#0000C0">=</font> <font color="#000000">mkdict</font><font color="#0000C0">(</font>
    <font color="#008000"># core</font>
    <font color="#000000">aa</font><font color="#0000C0">=</font><font color="#004080">"analysisAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ca</font><font color="#0000C0">=</font><font color="#004080">"cloneAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">cfa</font><font color="#0000C0">=</font><font color="#004080">"cloneFragmentAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ea</font><font color="#0000C0">=</font><font color="#004080">"exonAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">fa</font><font color="#0000C0">=</font><font color="#004080">"featureAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ga</font><font color="#0000C0">=</font><font color="#004080">"geneAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">lc</font><font color="#0000C0">=</font><font color="#004080">"locationConverterAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ma</font><font color="#0000C0">=</font><font color="#004080">"markerAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">pa</font><font color="#0000C0">=</font><font color="#004080">"dnaProteinAlignmentAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">pta</font><font color="#0000C0">=</font><font color="#004080">"predictionTranscriptAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ra</font><font color="#0000C0">=</font><font color="#004080">"repeatFeatureAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">sa</font><font color="#0000C0">=</font><font color="#004080">"sequenceAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">siea</font><font color="#0000C0">=</font><font color="#004080">"stableIdEventAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">spa</font><font color="#0000C0">=</font><font color="#004080">"simplePeptideFeatureAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">tna</font><font color="#0000C0">=</font><font color="#004080">"translationAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">tta</font><font color="#0000C0">=</font><font color="#004080">"transcriptAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">vara</font><font color="#0000C0">=</font><font color="#004080">"variationAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">xdba</font><font color="#0000C0">=</font><font color="#004080">"externalDatabaseAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">xra</font><font color="#0000C0">=</font><font color="#004080">"externalRefAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">mfa</font><font color="#0000C0">=</font><font color="#004080">"miscFeatureAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">msa</font><font color="#0000C0">=</font><font color="#004080">"miscSetAdaptor"</font><font color="#0000C0">,</font>

    <font color="#008000"># compara</font>
    <font color="#000000">ddafa</font><font color="#0000C0">=</font><font color="#004080">"dnaDnaAlignFeatureAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">dfa</font><font color="#0000C0">=</font><font color="#004080">"dnaFragmentAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">gaa</font><font color="#0000C0">=</font><font color="#004080">"genomicAlignAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">gdba</font><font color="#0000C0">=</font><font color="#004080">"genomeDbAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">ha</font><font color="#0000C0">=</font><font color="#004080">"homologyAdaptor"</font><font color="#0000C0">,</font>
    <font color="#000000">mla</font><font color="#0000C0">=</font><font color="#004080">"methodLinkAdaptor"</font>
    <font color="#0000C0">)</font>

<font color="#C00000">try</font><font color="#0000C0">:</font>
    <font color="#000000">ENSEMBL_USER_REGISTRY</font> <font color="#0000C0">=</font> <font color="#000000">os</font><font color="#0000C0">.</font><font color="#000000">environ</font><font color="#0000C0">[</font><font color="#004080">"ENSEMBL_USER_REGISTRY"</font><font color="#0000C0">]</font>
<font color="#C00000">except</font> <font color="#000000">KeyError</font><font color="#0000C0">:</font>
    <font color="#000000">ENSEMBL_USER_REGISTRY</font> <font color="#0000C0">=</font> <font color="#000000">os</font><font color="#0000C0">.</font><font color="#000000">path</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#000000">_within_user_home</font><font color="#0000C0">(</font><font color="#004080">".ensembl"</font><font color="#0000C0">)</font><font color="#0000C0">,</font><font color="#004080">".ensembl_user_registry.ini"</font><font color="#0000C0">)</font>

<font color="#C00000">try</font><font color="#0000C0">:</font> <font color="#008000"># if we are using ensj schema20</font>
    <font color="#C00000">from</font> <font color="#000000">org</font><font color="#0000C0">.</font><font color="#000000">ensembl</font><font color="#0000C0">.</font><font color="#000000">datamodel</font> <font color="#C00000">import</font> <font color="#000000">Location</font><font color="#0000C0">,</font> <font color="#000000">CoordinateSystem</font>

    <font color="#000000">CS_CHROMOSOME</font> <font color="#0000C0">=</font> <font color="#000000">CoordinateSystem</font><font color="#0000C0">(</font><font color="#004080">"chromosome"</font><font color="#0000C0">)</font>
    <font color="#000000">CS_CONTIG</font> <font color="#0000C0">=</font> <font color="#000000">CoordinateSystem</font><font color="#0000C0">(</font><font color="#004080">"contig"</font><font color="#0000C0">)</font>

<font color="#C00000">except</font> <font color="#000000">ImportError</font><font color="#0000C0">:</font> <font color="#008000"># older schema</font>
    <font color="#C00000">pass</font>

<font color="#C00000">class</font> <font color="#000000">DriverFacade</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    Abstract Base class which lazy loads a driver defined by a configuration.

    The parameter specifies the database connection parameters.
    These can be supplied as a filename string specifying the path to
    a properties file, a java.utils.Properties instance
    or a python dictionary.
    """</font>
    <font color="#C00000">def</font> <font color="#000000">__init__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">configuration</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">import</font> <font color="#000000">types</font>
        <font color="#C00000">if</font> <font color="#000000">type</font><font color="#0000C0">(</font><font color="#000000">configuration</font><font color="#0000C0">)</font> <font color="#0000C0">==</font> <font color="#000000">types</font><font color="#0000C0">.</font><font color="#000000">DictType</font><font color="#0000C0">:</font> <font color="#008000"># python dictionary</font>
            <font color="#000000">configuration</font> <font color="#0000C0">=</font> <font color="#000000">dictToProperties</font><font color="#0000C0">(</font><font color="#000000">configuration</font><font color="#0000C0">)</font>
        <font color="#C00000">elif</font> <font color="#000000">type</font><font color="#0000C0">(</font><font color="#000000">configuration</font><font color="#0000C0">)</font> <font color="#0000C0">==</font> <font color="#000000">types</font><font color="#0000C0">.</font><font color="#000000">StringType</font><font color="#0000C0">:</font> <font color="#008000"># file</font>
            <font color="#000000">configuration</font> <font color="#0000C0">=</font> <font color="#000000">util</font><font color="#0000C0">.</font><font color="#000000">PropertiesUtil</font><font color="#0000C0">.</font><font color="#000000">createProperties</font><font color="#0000C0">(</font><font color="#000000">configuration</font><font color="#0000C0">)</font>
        <font color="#C00000">if</font> <font color="#C00000">not</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">configuration</font><font color="#0000C0">,</font><font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">util</font><font color="#0000C0">.</font><font color="#000000">Properties</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
            <font color="#C00000">raise</font> <font color="#000000">Exception</font><font color="#0000C0">(</font><font color="#004080">"configuration must be a python dictionary or java.util.Properties object."</font><font color="#0000C0">)</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">configuration</font> <font color="#0000C0">=</font> <font color="#000000">configuration</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_uninitialized</font> <font color="#0000C0">=</font> <font color="#0080C0">1</font>

    <font color="#C00000">def</font> <font color="#000000">_init_driver</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">pass</font>

    <font color="#C00000">def</font> <font color="#000000">_init</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">if</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_uninitialized</font><font color="#0000C0">:</font>
            <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_init_driver</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
            <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_uninitialized</font> <font color="#0000C0">=</font> <font color="#0080C0">0</font>

    <font color="#C00000">def</font> <font color="#000000">__getattr__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_init</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#C00000">return</font> <font color="#000000">getattr</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">)</font> <font color="#008000"># if attribute is not on driver, raise AttributeError</font>

    <font color="#C00000">def</font> <font color="#000000">sql</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">sql</font><font color="#0000C0">,</font> <font color="#000000">cell_delimiter</font><font color="#0000C0">=</font><font color="#004080">"\t"</font><font color="#0000C0">,</font> <font color="#000000">outfile</font><font color="#0000C0">=</font><font color="#000000">sys</font><font color="#0000C0">.</font><font color="#000000">stdout</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#004080">"""
        Executes sql query and prints result.
        """</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_init</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">conn</font> <font color="#0000C0">=</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">getConnection</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">stmt</font> <font color="#0000C0">=</font> <font color="#000000">conn</font><font color="#0000C0">.</font><font color="#000000">createStatement</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">rs</font> <font color="#0000C0">=</font> <font color="#000000">stmt</font><font color="#0000C0">.</font><font color="#000000">executeQuery</font><font color="#0000C0">(</font><font color="#000000">sql</font><font color="#0000C0">)</font>
        <font color="#000000">last_column</font> <font color="#0000C0">=</font> <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">metaData</font><font color="#0000C0">.</font><font color="#000000">columnCount</font> <font color="#0000C0">+</font> <font color="#0080C0">1</font>
        <font color="#C00000">while</font> <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">next</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
            <font color="#C00000">print</font> <font color="#0000C0">&gt;&gt;</font><font color="#000000">outfile</font><font color="#0000C0">,</font> <font color="#000000">cell_delimiter</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#0000C0">[</font><font color="#000000">_get_string</font><font color="#0000C0">(</font><font color="#000000">rs</font><font color="#0000C0">,</font> <font color="#000000">column_index</font><font color="#0000C0">)</font>
                                                  <font color="#C00000">for</font> <font color="#000000">column_index</font> <font color="#C00000">in</font> <font color="#000000">xrange</font><font color="#0000C0">(</font><font color="#0080C0">1</font><font color="#0000C0">,</font> <font color="#000000">last_column</font><font color="#0000C0">)</font><font color="#0000C0">]</font><font color="#0000C0">)</font>
        <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">stmt</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">conn</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>

    <font color="#C00000">def</font> <font color="#000000">__str__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_init</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#C00000">return</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font><font color="#0000C0">.</font><font color="#000000">toString</font><font color="#0000C0">(</font><font color="#0000C0">)</font>

    <font color="#C00000">def</font> <font color="#000000">__repr__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">_init</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#C00000">return</font> <font color="#004080">"&lt;DriverFacade('%s')&gt;"</font> <font color="#0000C0">%</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font>


<font color="#C00000">class</font> <font color="#000000">CoreDriverFacade</font><font color="#0000C0">(</font><font color="#000000">DriverFacade</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">def</font> <font color="#000000">_init_driver</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font> <font color="#0000C0">=</font> <font color="#000000">CoreDriverImpl</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">configuration</font><font color="#0000C0">)</font>


<font color="#C00000">class</font> <font color="#000000">VariationDriverFacade</font><font color="#0000C0">(</font><font color="#000000">DriverFacade</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">def</font> <font color="#000000">_init_driver</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font> <font color="#0000C0">=</font> <font color="#000000">VariationDriverImpl</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">configuration</font><font color="#0000C0">)</font>


<font color="#C00000">class</font> <font color="#000000">ComparaDriverFacade</font><font color="#0000C0">(</font><font color="#000000">DriverFacade</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">def</font> <font color="#000000">_init_driver</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver</font> <font color="#0000C0">=</font> <font color="#000000">ComparaDriverImpl</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">configuration</font><font color="#0000C0">)</font>


<font color="#C00000">class</font> <font color="#000000">DriverGroupFacade</font><font color="#0000C0">:</font>

    <font color="#004080">""" Wrapper around DriverGroup instances that provides automatic
    delegation to embedded drivers. """</font>

    <font color="#C00000">def</font> <font color="#000000">__init__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">driver_group</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font> <font color="#0000C0">=</font> <font color="#000000">driver_group</font>

    <font color="#C00000">def</font> <font color="#000000">__str__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">toString</font><font color="#0000C0">(</font><font color="#0000C0">)</font>

    <font color="#C00000">def</font> <font color="#000000">__repr__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#004080">"&lt;DriverGroupFacade('%s')&gt;"</font> <font color="#0000C0">%</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font>

    <font color="#C00000">def</font> <font color="#000000">__getattr__</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">)</font><font color="#0000C0">:</font>

        <font color="#004080">""" Delegates to first available instance in the list
        driver_group, coreDriver, variationDriver and comparaDriver.

        Note: it can be much faster to call
        driver_group_facade.driver_group.xxxDriver.yyyAttribute than
        driver_group_facade.yyyAttribute.

        """</font>

        <font color="#C00000">if</font> <font color="#000000">ADAPTOR_ABBREVIATIONS</font><font color="#0000C0">.</font><font color="#000000">has_key</font><font color="#0000C0">(</font><font color="#000000">name</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
            <font color="#000000">name</font> <font color="#0000C0">=</font> <font color="#000000">ADAPTOR_ABBREVIATIONS</font><font color="#0000C0">[</font><font color="#000000">name</font><font color="#0000C0">]</font>
        <font color="#C00000">for</font> <font color="#000000">obj</font> <font color="#C00000">in</font> <font color="#0000C0">[</font><font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">,</font>
                    <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">coreDriver</font><font color="#0000C0">,</font>
                    <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">variationDriver</font><font color="#0000C0">,</font>
                    <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">comparaDriver</font> <font color="#0000C0">]</font><font color="#0000C0">:</font>
            <font color="#C00000">try</font><font color="#0000C0">:</font>
                <font color="#000000">attr</font> <font color="#0000C0">=</font> <font color="#000000">getattr</font><font color="#0000C0">(</font><font color="#000000">obj</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">)</font>
                <font color="#C00000">if</font> <font color="#000000">attr</font><font color="#0000C0">:</font>
                    <font color="#C00000">return</font> <font color="#000000">attr</font>
            <font color="#C00000">except</font> <font color="#000000">AttributeError</font><font color="#0000C0">:</font>
                <font color="#C00000">pass</font>
        <font color="#C00000">raise</font> <font color="#000000">AttributeError</font>

    <font color="#C00000">def</font> <font color="#000000">sql</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font> <font color="#000000">sql</font><font color="#0000C0">,</font> <font color="#000000">cell_delimiter</font><font color="#0000C0">=</font><font color="#004080">"\t"</font><font color="#0000C0">,</font> <font color="#000000">outfile</font><font color="#0000C0">=</font><font color="#000000">sys</font><font color="#0000C0">.</font><font color="#000000">stdout</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#004080">"""
        Executes sql query against one of the underlying drivers and prints result. Delegates
        to first available driver in list coreDriver, variationDriver and comparaDriver.

        If you want to use a specific driver then you must use it directly e.g. facade.coreDriver.
        """</font>
        <font color="#000000">conn</font> <font color="#0000C0">=</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">connection</font> <font color="#008000"># auto delegate via __getattr__ to appropriatte driver</font>
        <font color="#000000">stmt</font> <font color="#0000C0">=</font> <font color="#000000">conn</font><font color="#0000C0">.</font><font color="#000000">createStatement</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">rs</font> <font color="#0000C0">=</font> <font color="#000000">stmt</font><font color="#0000C0">.</font><font color="#000000">executeQuery</font><font color="#0000C0">(</font><font color="#000000">sql</font><font color="#0000C0">)</font>
        <font color="#000000">last_column</font> <font color="#0000C0">=</font> <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">metaData</font><font color="#0000C0">.</font><font color="#000000">columnCount</font> <font color="#0000C0">+</font> <font color="#0080C0">1</font>
        <font color="#C00000">while</font> <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">next</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
            <font color="#C00000">print</font> <font color="#0000C0">&gt;&gt;</font><font color="#000000">outfile</font><font color="#0000C0">,</font> <font color="#000000">cell_delimiter</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#0000C0">[</font><font color="#000000">_get_string</font><font color="#0000C0">(</font><font color="#000000">rs</font><font color="#0000C0">,</font> <font color="#000000">column_index</font><font color="#0000C0">)</font>
                                                  <font color="#C00000">for</font> <font color="#000000">column_index</font> <font color="#C00000">in</font> <font color="#000000">xrange</font><font color="#0000C0">(</font><font color="#0080C0">1</font><font color="#0000C0">,</font> <font color="#000000">last_column</font><font color="#0000C0">)</font><font color="#0000C0">]</font><font color="#0000C0">)</font>
        <font color="#000000">rs</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">stmt</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
        <font color="#000000">conn</font><font color="#0000C0">.</font><font color="#000000">close</font><font color="#0000C0">(</font><font color="#0000C0">)</font>


    <font color="#C00000">def</font> <font color="#000000">all_genes</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font><font color="#000000">loadChildren</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#004080">"""Returns an iterator over all genes. Set 'loadChildren=1' if you want
        transcripts, exons and translations to be preloaded which makes accessing them faster."""</font>
        <font color="#C00000">return</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">geneAdaptor</font><font color="#0000C0">.</font><font color="#000000">fetchIterator</font><font color="#0000C0">(</font><font color="#000000">loadChildren</font><font color="#0000C0">)</font>

    <font color="#C00000">def</font> <font color="#000000">all_transcripts</font><font color="#0000C0">(</font><font color="#000000">self</font><font color="#0000C0">,</font><font color="#000000">loadChildren</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#004080">"""Returns an iterator over all transcripts. Set 'loadChildren=1' if you want
        exons and translations to be preloaded which makes accessing them faster."""</font>
        <font color="#C00000">return</font> <font color="#000000">self</font><font color="#0000C0">.</font><font color="#000000">transcriptAdaptor</font><font color="#0000C0">.</font><font color="#000000">fetchIterator</font><font color="#0000C0">(</font><font color="#000000">loadChildren</font><font color="#0000C0">)</font>


<font color="#008000">#### functions
</font>
<font color="#C00000">def</font> <font color="#000000">dictToProperties</font><font color="#0000C0">(</font><font color="#000000">dict</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">from</font> <font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">util</font> <font color="#C00000">import</font> <font color="#000000">Properties</font>
    <font color="#000000">p</font> <font color="#0000C0">=</font> <font color="#000000">Properties</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
    <font color="#C00000">for</font> <font color="#000000">key</font><font color="#0000C0">,</font><font color="#000000">value</font> <font color="#C00000">in</font> <font color="#000000">dict</font><font color="#0000C0">.</font><font color="#000000">items</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">p</font><font color="#0000C0">.</font><font color="#000000">put</font><font color="#0000C0">(</font><font color="#000000">key</font><font color="#0000C0">,</font> <font color="#000000">value</font><font color="#0000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">p</font>


<font color="#C00000">def</font> <font color="#000000">_sorted</font><font color="#0000C0">(</font><font color="#000000">seq</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#000000">res</font> <font color="#0000C0">=</font> <font color="#000000">list</font><font color="#0000C0">(</font><font color="#000000">seq</font><font color="#0000C0">)</font>
    <font color="#000000">res</font><font color="#0000C0">.</font><font color="#000000">sort</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">res</font>

<font color="#C00000">def</font> <font color="#000000">_get_string</font><font color="#0000C0">(</font><font color="#000000">result_set</font><font color="#0000C0">,</font> <font color="#000000">column_index</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#000000">res</font> <font color="#0000C0">=</font> <font color="#000000">result_set</font><font color="#0000C0">.</font><font color="#000000">getString</font><font color="#0000C0">(</font><font color="#000000">column_index</font><font color="#0000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">res</font> <font color="#C00000">is</font> <font color="#000000">None</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#004080">"NULL"</font>
    <font color="#C00000">else</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">res</font>

<font color="#C00000">def</font> <font color="#000000">_set_property</font><font color="#0000C0">(</font><font color="#000000">properties</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">,</font> <font color="#000000">value</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">try</font><font color="#0000C0">:</font>
        <font color="#000000">properties</font><font color="#0000C0">[</font><font color="#000000">name</font><font color="#0000C0">]</font> <font color="#0000C0">=</font> <font color="#000000">value</font>
    <font color="#C00000">except</font> <font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">lang</font><font color="#0000C0">.</font><font color="#000000">NullPointerException</font><font color="#0000C0">:</font>
        <font color="#C00000">pass</font>

<font color="#C00000">def</font> <font color="#000000">_locrepr</font><font color="#0000C0">(</font><font color="#000000">location</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">return</font> <font color="#004080">"(%s:%s%s%s)"</font> <font color="#0000C0">%</font> <font color="#0000C0">(</font><font color="#000000">location</font><font color="#0000C0">.</font><font color="#000000">seqRegionName</font><font color="#0000C0">,</font>
                            <font color="#000000">location</font><font color="#0000C0">.</font><font color="#000000">start</font><font color="#0000C0">,</font>
                            <font color="#000000">STRAND_SYMBOLS</font><font color="#0000C0">[</font><font color="#000000">location</font><font color="#0000C0">.</font><font color="#000000">strand</font><font color="#0000C0">]</font><font color="#0000C0">,</font>
                            <font color="#000000">location</font><font color="#0000C0">.</font><font color="#000000">end</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">ensrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">=</font><font color="#004080">", "</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    compact representation of common ensembl objects
    """</font>
    <font color="#C00000">return</font> <font color="#000000">_ensrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#004080">""</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">ensstr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">=</font><font color="#000000">None</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    pretty-printed representation of common ensembl objects
    """</font>
    <font color="#000000">delimiter</font> <font color="#0000C0">=</font> <font color="#004080">"\n"</font> <font color="#0000C0">+</font> <font color="#004080">" "</font> <font color="#0000C0">*</font> <font color="#0000C0">(</font><font color="#000000">add_space</font><font color="#0000C0">+</font><font color="#0080C0">1</font><font color="#0000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">_ensrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">+</font><font color="#0080C0">1</font><font color="#0000C0">,</font> <font color="#000000">list_str_function</font><font color="#0000C0">=</font><font color="#000000">_ensstr_list</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">_ensstr_list</font><font color="#0000C0">(</font><font color="#000000">items</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">,</font> <font color="#000000">str_function</font><font color="#0000C0">=</font><font color="#000000">ensstr</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">return</font> <font color="#004080">"%s"</font> <font color="#0000C0">%</font> <font color="#000000">delimiter</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#0000C0">[</font><font color="#000000">str_function</font><font color="#0000C0">(</font><font color="#000000">item</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">)</font> <font color="#C00000">for</font> <font color="#000000">item</font> <font color="#C00000">in</font> <font color="#000000">items</font><font color="#0000C0">]</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">_ensrepr_list</font><font color="#0000C0">(</font><font color="#000000">items</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">=</font><font color="#0080C0">0</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">return</font> <font color="#004080">"[%s]"</font> <font color="#0000C0">%</font> <font color="#000000">_ensstr_list</font><font color="#0000C0">(</font><font color="#000000">items</font><font color="#0000C0">,</font> <font color="#000000">delimiter</font><font color="#0000C0">,</font> <font color="#000000">str_function</font><font color="#0000C0">=</font><font color="#000000">ensrepr</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">_ensrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">sole_delimiter</font><font color="#0000C0">,</font> <font color="#000000">header_delimiter</font><font color="#0000C0">,</font> <font color="#000000">body_delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">,</font> <font color="#000000">list_str_function</font><font color="#0000C0">=</font><font color="#000000">_ensrepr_list</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">if</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">java</font><font color="#0000C0">.</font><font color="#000000">util</font><font color="#0000C0">.</font><font color="#000000">ArrayList</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">_ensrepr_list</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">sole_delimiter</font><font color="#0000C0">)</font> <font color="#008000"># always call _ensrepr_list and not list_str_function</font>
    <font color="#C00000">if</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">datamodel</font><font color="#0000C0">.</font><font color="#000000">Location</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">_locrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">datamodel</font><font color="#0000C0">.</font><font color="#000000">Exon</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">accessionID</font> <font color="#0000C0">+</font> <font color="#000000">_locrepr</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">location</font><font color="#0000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">datamodel</font><font color="#0000C0">.</font><font color="#000000">Transcript</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">accessionID</font> <font color="#0000C0">+</font> <font color="#000000">header_delimiter</font> <font color="#0000C0">+</font> <font color="#000000">list_str_function</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">exons</font><font color="#0000C0">,</font> <font color="#000000">body_delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">isinstance</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">,</font> <font color="#000000">datamodel</font><font color="#0000C0">.</font><font color="#000000">Gene</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">accessionID</font> <font color="#0000C0">+</font> <font color="#000000">header_delimiter</font> <font color="#0000C0">+</font> <font color="#000000">list_str_function</font><font color="#0000C0">(</font><font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">transcripts</font><font color="#0000C0">,</font> <font color="#000000">body_delimiter</font><font color="#0000C0">,</font> <font color="#000000">add_space</font><font color="#0000C0">=</font><font color="#0080C0">1</font><font color="#0000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">feature</font><font color="#0000C0">.</font><font color="#000000">accessionID</font>

<font color="#C00000">def</font> <font color="#000000">_set_ensid_prefix</font><font color="#0000C0">(</font><font color="#000000">ensid_prefix</font><font color="#0000C0">,</font> <font color="#000000">driver_group_facade</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">if</font> <font color="#000000">ensid_prefix</font><font color="#0000C0">:</font>
        <font color="#C00000">for</font> <font color="#000000">infix</font><font color="#0000C0">,</font> <font color="#000000">adaptor_name</font> <font color="#C00000">in</font> <font color="#000000">ENSID_INFIXES</font><font color="#0000C0">.</font><font color="#000000">items</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
            <font color="#000000">_adaptors</font><font color="#0000C0">[</font><font color="#000000">ensid_prefix</font> <font color="#0000C0">+</font> <font color="#000000">infix</font><font color="#0000C0">]</font> <font color="#0000C0">=</font> <font color="#000000">getattr</font><font color="#0000C0">(</font><font color="#000000">driver_group_facade</font><font color="#0000C0">,</font> <font color="#000000">adaptor_name</font><font color="#0000C0">)</font>

<font color="#000000">re_ensid_type</font> <font color="#0000C0">=</font> <font color="#000000">re</font><font color="#0000C0">.</font><font color="#000000">compile</font><font color="#0000C0">(</font><font color="#004080">r"^\D+"</font><font color="#0000C0">)</font> <font color="#008000"># start-of-line; (any-non-digit-character) one-or-more-times</font>
<font color="#000000">re_ensid_unversioned</font> <font color="#0000C0">=</font> <font color="#000000">re</font><font color="#0000C0">.</font><font color="#000000">compile</font><font color="#0000C0">(</font><font color="#004080">r"^([^.]+)"</font><font color="#0000C0">)</font> <font color="#008000"># start-of-line; (any-character-besides-".") one-or-more-times</font>
<font color="#C00000">def</font> <font color="#000000">fetch</font><font color="#0000C0">(</font><font color="#000000">ensid</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    figure out which adaptor to use and fetch from it
    """</font>
    <font color="#000000">type_prefix</font> <font color="#0000C0">=</font> <font color="#000000">re_ensid_type</font><font color="#0000C0">.</font><font color="#000000">match</font><font color="#0000C0">(</font><font color="#000000">ensid</font><font color="#0000C0">)</font><font color="#0000C0">.</font><font color="#000000">group</font><font color="#0000C0">(</font><font color="#0080C0">0</font><font color="#0000C0">)</font>
    <font color="#C00000">try</font><font color="#0000C0">:</font>
        <font color="#000000">adaptor</font> <font color="#0000C0">=</font> <font color="#000000">_prefix_2_adaptors</font><font color="#0000C0">[</font><font color="#000000">type_prefix</font><font color="#0000C0">]</font>
    <font color="#C00000">except</font> <font color="#000000">KeyError</font><font color="#0000C0">:</font>
        <font color="#C00000">try</font><font color="#0000C0">:</font>
            <font color="#000000">ensembl_prefix</font> <font color="#0000C0">=</font> <font color="#000000">type_prefix</font><font color="#0000C0">[</font><font color="#0080C0">0</font><font color="#0000C0">:</font><font color="#0000C0">-</font><font color="#0080C0">1</font><font color="#0000C0">]</font> <font color="#008000"># e.g. ENSG -&gt; ENS</font>
            <font color="#000000">driver_group_facade</font> <font color="#0000C0">=</font> <font color="#000000">_prefix_2_driver_group_facade</font><font color="#0000C0">[</font><font color="#000000">ensembl_prefix</font><font color="#0000C0">]</font>
            <font color="#000000">adaptor_letter</font> <font color="#0000C0">=</font> <font color="#000000">type_prefix</font><font color="#0000C0">[</font><font color="#0000C0">-</font><font color="#0080C0">1</font><font color="#0000C0">]</font>
            <font color="#000000">adaptor_type</font> <font color="#0000C0">=</font> <font color="#000000">ENSID_INFIXES</font><font color="#0000C0">.</font><font color="#000000">get</font><font color="#0000C0">(</font><font color="#000000">adaptor_letter</font><font color="#0000C0">)</font>
            <font color="#C00000">if</font> <font color="#000000">adaptor_type</font><font color="#0000C0">:</font>
                <font color="#000000">adaptor</font> <font color="#0000C0">=</font> <font color="#000000">getattr</font><font color="#0000C0">(</font><font color="#000000">driver_group_facade</font><font color="#0000C0">,</font> <font color="#000000">adaptor_type</font><font color="#0000C0">)</font>
                <font color="#000000">_prefix_2_driver_group_facade</font><font color="#0000C0">[</font><font color="#000000">type_prefix</font><font color="#0000C0">]</font> <font color="#0000C0">=</font> <font color="#000000">adaptor</font>
            <font color="#C00000">else</font><font color="#0000C0">:</font>
                <font color="#C00000">return</font> <font color="#000000">None</font>
            <font color="#008000">#raise ValueError, "Ensembl ID must start with letter"
</font>        <font color="#C00000">except</font> <font color="#000000">KeyError</font><font color="#0000C0">,</font> <font color="#000000">key</font><font color="#0000C0">:</font>
            <font color="#C00000">raise</font> <font color="#000000">KeyError</font><font color="#0000C0">,</font> <font color="#004080">"cannot use ensembl.fetch to fetch IDs starting with %s"</font> <font color="#0000C0">%</font> <font color="#000000">key</font>
    <font color="#000000">ensid_unversioned</font> <font color="#0000C0">=</font> <font color="#000000">re_ensid_unversioned</font><font color="#0000C0">.</font><font color="#000000">match</font><font color="#0000C0">(</font><font color="#000000">ensid</font><font color="#0000C0">)</font><font color="#0000C0">.</font><font color="#000000">group</font><font color="#0000C0">(</font><font color="#0080C0">1</font><font color="#0000C0">)</font>

    <font color="#C00000">return</font> <font color="#000000">adaptor</font><font color="#0000C0">.</font><font color="#000000">fetch</font><font color="#0000C0">(</font><font color="#000000">ensid_unversioned</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">_format_driver_name</font><font color="#0000C0">(</font><font color="#000000">driver_name</font><font color="#0000C0">,</font> <font color="#000000">driver</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">return</font> <font color="#000000">driver_name</font>

<font color="#C00000">def</font> <font color="#000000">print_drivers</font><font color="#0000C0">(</font><font color="#000000">drivers</font><font color="#0000C0">=</font><font color="#000000">drivers</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#004080">"""
    print the loaded drivers
    """</font>
    <font color="#C00000">print</font> <font color="#004080">"\n"</font><font color="#0000C0">.</font><font color="#000000">join</font><font color="#0000C0">(</font><font color="#0000C0">[</font><font color="#000000">_format_driver_name</font><font color="#0000C0">(</font><font color="#000000">driver_name</font><font color="#0000C0">,</font> <font color="#000000">driver</font><font color="#0000C0">)</font> <font color="#C00000">for</font> <font color="#000000">driver_name</font><font color="#0000C0">,</font> <font color="#000000">driver</font> <font color="#C00000">in</font> <font color="#000000">_sorted</font><font color="#0000C0">(</font><font color="#000000">drivers</font><font color="#0000C0">.</font><font color="#000000">items</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">)</font><font color="#0000C0">]</font><font color="#0000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">load_registry</font><font color="#0000C0">(</font><font color="#000000">registry</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#C00000">for</font> <font color="#000000">name</font> <font color="#C00000">in</font> <font color="#000000">registry</font><font color="#0000C0">.</font><font color="#000000">groupNames</font><font color="#0000C0">:</font>
        <font color="#000000">r</font> <font color="#0000C0">=</font> <font color="#000000">DriverGroupFacade</font><font color="#0000C0">(</font><font color="#000000">registry</font><font color="#0000C0">.</font><font color="#000000">getGroup</font><font color="#0000C0">(</font><font color="#000000">name</font><font color="#0000C0">)</font><font color="#0000C0">)</font>
        <font color="#000000">setattr</font><font color="#0000C0">(</font><font color="#000000">sys</font><font color="#0000C0">.</font><font color="#000000">modules</font><font color="#0000C0">[</font><font color="#000000">__name__</font><font color="#0000C0">]</font><font color="#0000C0">,</font> <font color="#000000">name</font><font color="#0000C0">,</font> <font color="#000000">r</font><font color="#0000C0">)</font> <font color="#008000"># add facade as an attribute of the current module (ensembl)</font>
        <font color="#000000">drivers</font><font color="#0000C0">[</font><font color="#000000">name</font><font color="#0000C0">]</font><font color="#0000C0">=</font><font color="#000000">r</font>
        <font color="#008000"># Note: use r.driver_group.getXXXCoreConfig() instead of r.getXXXCoreConfig() because (a) it's much faster,
</font>        <font color="#008000"># and (b) the former prevents reload(ensembl) from working for some reason.
</font>        <font color="#C00000">for</font> <font color="#000000">conf</font> <font color="#C00000">in</font> <font color="#0000C0">[</font><font color="#000000">r</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">getCoreConfig</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">,</font> <font color="#000000">r</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">getVariationConfig</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">,</font> <font color="#000000">r</font><font color="#0000C0">.</font><font color="#000000">driver_group</font><font color="#0000C0">.</font><font color="#000000">getComparaConfig</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">]</font><font color="#0000C0">:</font>
            <font color="#C00000">if</font> <font color="#000000">conf</font> <font color="#C00000">and</font> <font color="#000000">conf</font><font color="#0000C0">.</font><font color="#000000">containsKey</font><font color="#0000C0">(</font><font color="#004080">"ensembl_prefix"</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
                <font color="#000000">_prefix_2_driver_group_facade</font><font color="#0000C0">[</font><font color="#000000">conf</font><font color="#0000C0">.</font><font color="#000000">getProperty</font><font color="#0000C0">(</font><font color="#004080">"ensembl_prefix"</font><font color="#0000C0">)</font><font color="#0000C0">]</font> <font color="#0000C0">=</font> <font color="#000000">r</font>

<font color="#C00000">def</font> <font color="#000000">_setup</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
    <font color="#000000">_prefix_2_driver_group_facade</font><font color="#0000C0">.</font><font color="#000000">clear</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
    <font color="#000000">_prefix_2_adaptors</font><font color="#0000C0">.</font><font color="#000000">clear</font><font color="#0000C0">(</font><font color="#0000C0">)</font>
    <font color="#000000">load_registry</font><font color="#0000C0">(</font><font color="#000000">registry</font><font color="#0000C0">.</font><font color="#000000">Registry</font><font color="#0000C0">.</font><font color="#000000">createDefaultRegistry</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">)</font>

    <font color="#C00000">if</font> <font color="#000000">registry</font><font color="#0000C0">.</font><font color="#000000">Registry</font><font color="#0000C0">.</font><font color="#000000">isDefaultUserRegistryAvailable</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">:</font>
        <font color="#000000">load_registry</font><font color="#0000C0">(</font><font color="#000000">registry</font><font color="#0000C0">.</font><font color="#000000">Registry</font><font color="#0000C0">.</font><font color="#000000">createDefaultUserRegistry</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#0000C0">)</font>


    <font color="#008000">## REMAINING CODE IN FUNCTION TO BE MOVED TO UNIT TEST
</font>
    <font color="#008000">##module = sys.modules[__name__]
</font>    <font color="#008000">## print dir(module)
</font><font color="#008000">##     print "module.human", module.human
</font><font color="#008000">#    print "module.human.geneAdaptor", module.human.geneAdaptor
</font><font color="#008000">##     print "module.human.ga", module.human.ga
</font><font color="#008000">##     print "module.human.variationAdaptor", module.human.variationAdaptor
</font><font color="#008000">##     print "module.compara", module.compara
</font>    <font color="#008000">#print "show databases", module.compara.sql("show databases")
</font><font color="#008000">#    d  = CoreDriverFacade({"database":"mus_musculus_core_32_34", "user":"ensro","port":"23364","host":"127.0.0.1"})
</font><font color="#008000">##     print d
</font><font color="#008000">##     d = CoreDriverFacade("/home/craig/.ensembl/unit_test_core.properties")
</font><font color="#008000">##     print d
</font>    <font color="#008000">#d = CoreDriverFacade("bob")
</font>    <font color="#008000">#print d
</font>    <font color="#008000">#print _prefix_2_driver_group_facade
</font>
<font color="#008000">##     print module.fetch("ENSG00000172983")
</font><font color="#008000">##     print module.fetch("ENSE00001390003")
</font><font color="#008000">##     print module.fetch("ENST00000354715")
</font><font color="#008000">##     print module.fetch("ENSZ00001390003")
</font>
<font color="#000000">_setup</font><font color="#0000C0">(</font><font color="#0000C0">)</font><font color="#000000"></font></font></pre>